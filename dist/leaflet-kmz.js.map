{"version":3,"file":"leaflet-kmz.js","sources":["../src/KMZParser.js","../src/KMZLoader.js","../src/KMZMarker.js","../src/GridLayer.GeoJSON.js"],"sourcesContent":["L.KMZParser = L.Class.extend({\r\n\r\n  initialize: function(opts) {\r\n    L.setOptions(this, opts);\r\n    this.loaders = [];\r\n  },\r\n\r\n  load: function(kmzUrl, opts) {\r\n    this._loadAsyncJS(this._requiredJSModules()); // async download all required JS modules.\r\n    this._waitAsyncJS(this._loadKMZ.bind(this, kmzUrl, opts)); // wait until all JS modules are downloaded.\r\n  },\r\n\r\n  get: function(i) {\r\n    return i < this.loaders.length ? this.loaders[i] : false;\r\n  },\r\n\r\n  _loadKMZ: function(kmzUrl, opts) {\r\n    var kmzLoader = new L.KMZLoader(L.extend({}, this.options, opts));\r\n    kmzLoader.parse(kmzUrl);\r\n    this.loaders.push(kmzLoader);\r\n  },\r\n\r\n  _loadAsyncJS: function(urls) {\r\n    if (!L.KMZParser._jsPromise && urls.length) {\r\n      var promises = urls.map(url => this._loadJS(url));\r\n      L.KMZParser._jsPromisePending = true;\r\n      L.KMZParser._jsPromise = Promise.all(promises).then(function() {\r\n        L.KMZParser._jsPromisePending = false;\r\n      }.bind(this));\r\n    }\r\n  },\r\n\r\n  _loadJS: function(url) {\r\n    return new Promise(function(resolve, reject) {\r\n      var tag = document.createElement(\"script\");\r\n      tag.type = \"text/javascript\";\r\n      tag.src = url;\r\n      tag.onload = resolve.bind(url);\r\n      tag.onerror = reject.bind(url);\r\n      document.head.appendChild(tag);\r\n    });\r\n  },\r\n\r\n  _requiredJSModules: function() {\r\n    var urls = [];\r\n    var host = 'https://unpkg.com/';\r\n\r\n    if (typeof JSZip !== 'function' && typeof window.JSZip !== 'function') {\r\n      urls.push(host + 'jszip@3.1.5/dist/jszip.min.js');\r\n    }\r\n    if (typeof toGeoJSON !== 'object' && typeof window.toGeoJSON !== 'object') {\r\n      urls.push(host + '@tmcw/togeojson@3.0.1/dist/togeojsons.min.js');\r\n    }\r\n    if (typeof geojsonvt !== 'function' && typeof window.geojsonvt !== 'function') {\r\n      urls.push(host + 'geojson-vt@3.0.0/geojson-vt.js');\r\n    }\r\n\r\n    return urls;\r\n  },\r\n\r\n  _waitAsyncJS: function(callback) {\r\n    if (L.KMZParser._jsPromise && L.KMZParser._jsPromisePending) {\r\n      L.KMZParser._jsPromise.then(callback);\r\n    } else {\r\n      callback.call();\r\n    }\r\n  },\r\n\r\n});\r\n\r\nexport var KMZParser = L.KMZParser;\r\n","// import JSZip from 'jszip';\r\n// import geojsonvt from 'geojson-vt';\r\n// import * as toGeoJSON from '@tmcw/togeojson';\r\n\r\nL.KMZLoader = L.Class.extend({\r\n\toptions: {\r\n\t\ttiled: true,\r\n\t\tinteractive: true,\r\n\t\tballon: true,\r\n\t\tbindPopup: true,\r\n\t\tbindTooltip: true,\r\n\t\tdebug: 0,\r\n\t\tkeepFront: true,\r\n\t},\r\n\r\n\tinitialize: function(opts) {\r\n\t\tL.setOptions(this, opts);\r\n\r\n\t\tthis.tiled = this.options.tiled; // (Optimized) GeoJSON Vector Tiles [\"geojson-vt.js\"] library.\r\n\t\tthis.interactive = this.options.interactive; // (Default) Mouse interactions through [\"leaflet.js\"] layers.\r\n\t\tthis.pointable = this.tiled && !this.interactive && this.options.pointable; // (Experimental) Optimized Mouse interactions through [\"geojson-vt.js\", \"leaflet-pointable.js\"] libraries.\r\n\t\tthis.emptyIcon = 'data:image/png;base64,' + \"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAFElEQVR4XgXAAQ0AAABAMP1L30IDCPwC/o5WcS4AAAAASUVORK5CYII=\";\r\n\t\tthis.name = this.options.name;\r\n\t\tthis.callback = opts.onKMZLoaded;\r\n\r\n\t\tthis._pointRenderer = L.canvas({ padding: 0.5, pane: 'markerPane' });\r\n\t},\r\n\r\n\tparse: function(kmzUrl) {\r\n\t\tthis.name = this.name ? this.name : kmzUrl.split('/').pop();\r\n\t\tthis._load(kmzUrl);\r\n\t},\r\n\r\n\t_load: function(url) {\r\n\t\tthis._getBinaryContent(url, function(err, data) {\r\n\t\t\tif (err != null) console.error(url, err, data);\r\n\t\t\telse this._parse(data);\r\n\t\t}.bind(this));\r\n\t},\r\n\r\n\t_parse: function(data) {\r\n\t\treturn this._isZipped(data) ? this._parseKMZ(data) : this._parseKML(data);\r\n\t},\r\n\r\n\t_parseKMZ: function(data) {\r\n\t\tvar that = this;\r\n\t\tJSZip.loadAsync(data).then((zip) => {\r\n\t\t\tPromise.all(that._mapZipFiles(zip)).then((list) => {\r\n\t\t\t\tPromise.all(that._mapListFiles(list)).then((data) => {\r\n\t\t\t\t\tvar kmlString = this._decodeKMZFolder(data);\r\n\t\t\t\t\tthat._parseKML(kmlString);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t},\r\n\r\n\t_parseKML: function(data) {\r\n\t\tvar kmlString = this._decodeKMLString(data);\r\n\t\tvar xmlDoc = this._toXML(kmlString);\r\n\t\tthis._kmlToLayer(xmlDoc);\r\n\t},\r\n\r\n\t_decodeKMLString: function(data) {\r\n\t\treturn data instanceof ArrayBuffer ? String.fromCharCode.apply(null, new Uint8Array(data)) : data;\r\n\t},\r\n\r\n\t_decodeKMZFolder: function(data) {\r\n\t\tvar kmzFiles = this._listToObject(data);\r\n\t\tvar kmlDoc = this._getKmlDoc(kmzFiles);\r\n\t\tvar images = this._getImageFiles(Object.keys(kmzFiles));\r\n\r\n\t\tvar kmlString = kmzFiles[kmlDoc];\r\n\r\n\t\t// replaces all images with their base64 encoding\r\n\t\tfor (var i in images) {\r\n\t\t\tvar imageUrl = images[i];\r\n\t\t\tvar dataUrl = kmzFiles[imageUrl];\r\n\t\t\tkmlString = this._replaceAll(kmlString, imageUrl, dataUrl);\r\n\t\t}\r\n\t\treturn kmlString;\r\n\t},\r\n\r\n\t_toXML: function(text) {\r\n\t\treturn (new DOMParser()).parseFromString(text, 'text/xml');\r\n\t},\r\n\r\n\t_toGeoJSON: function(xmlDoc) {\r\n\t\treturn (toGeoJSON || window.toGeoJSON).kml(xmlDoc);\r\n\t},\r\n\r\n\t_keepFront: function(layer) {\r\n\t\tvar keepFront = function(e) {\r\n\t\t\tif (this.bringToFront) this.bringToFront();\r\n\t\t}.bind(layer);\r\n\t\tlayer.on('add', function(e) {\r\n\t\t\tthis._map.on('baselayerchange', keepFront);\r\n\t\t});\r\n\t\tlayer.on('remove', function(e) {\r\n\t\t\tthis._map.off('baselayerchange', keepFront);\r\n\t\t});\r\n\t},\r\n\r\n\t_kmlToLayer: function(xmlDoc) {\r\n\t\tvar data = this._toGeoJSON(xmlDoc);\r\n\r\n\t\tif (this.interactive) {\r\n\t\t\tthis.geojson = L.geoJson(data, {\r\n\t\t\t\tpointToLayer: this._pointToLayer.bind(this),\r\n\t\t\t\tonEachFeature: this._onEachFeature.bind(this),\r\n\t\t\t});\r\n\t\t\tthis.layer = this.geojson;\r\n\t\t}\r\n\r\n\t\tif (this.tiled) {\r\n\t\t\tthis.gridlayer = L.gridLayer.geoJson(data, {\r\n\t\t\t\tpointable: this.pointable,\r\n\t\t\t\tballon: this.options.ballon,\r\n\t\t\t\tbindPopup: this.options.bindPopup,\r\n\t\t\t\tbindTooltip: this.options.bindTooltip,\r\n\t\t\t});\r\n\t\t\tthis.layer = this.interactive ? L.featureGroup([this.gridlayer, this.geojson]) : this.gridlayer;\r\n\t\t}\r\n\r\n\t\tif (this.layer) {\r\n\t\t\tthis._onKMZLoaded(this.layer, this.name);\r\n\t\t}\r\n\t},\r\n\r\n\t_pointToLayer: function(feature, latlng) {\r\n\t\treturn new L.KMZMarker(latlng, { renderer: this._pointRenderer, });\r\n\t\t// return new L.marker(latlng, {\r\n\t\t//   icon: L.icon({\r\n\t\t//   \ticonUrl: this.emptyIcon,\r\n\t\t//   }),\r\n\t\t// });\r\n\t},\r\n\r\n\t_onEachFeature: function(feature, layer) {\r\n\t\tswitch (feature.geometry.type) {\r\n\t\t\tcase 'Point':\r\n\t\t\t\tthis._setLayerPointIcon(feature, layer);\r\n\t\t\t\tbreak;\r\n\t\t\tcase 'LineString':\r\n\t\t\tcase 'Polygon':\r\n\t\t\tcase 'GeometryCollection':\r\n\t\t\t\tthis._setLayerStyle(feature, layer);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t\tconsole.warn('Unsupported feature type: ' + feature.geometry.type, feature);\r\n\t\t\t\tbreak;\r\n\t\t}\r\n\t\tthis._setLayerBalloon(feature, layer);\r\n\t},\r\n\r\n\t_onKMZLoaded: function(layer, name) {\r\n\t\tif (this.options.debug) console.log(layer, name);\r\n\t\tif (this.options.keepFront) this._keepFront(layer);\r\n\t\tif (this.callback) this.callback(layer, name);\r\n\t},\r\n\r\n\t_setLayerPointIcon: function(feature, layer) {\r\n\t\tlayer.setIconUrl(this.tiled ? this.emptyIcon : feature.properties.icon);\r\n\t\t// var width = 28;\r\n\t\t// var height = 28;\r\n\t\t// layer.setIcon(L.icon({\r\n\t\t// \ticonSize: [width, height],\r\n\t\t// \ticonAnchor: [width / 2, height / 2],\r\n\t\t// \ticonUrl: this.tiled ? this.emptyIcon : feature.properties.icon,\r\n\t\t// }));\r\n\t},\r\n\r\n\t_setLayerStyle: function(feature, layer) {\r\n\t\tvar styles = {\r\n\t\t\tweight: 1,\r\n\t\t\topacity: 0,\r\n\t\t\tfillOpacity: 0,\r\n\t\t};\r\n\t\tif (!this.tiled) {\r\n\t\t\tif (feature.properties[\"stroke-width\"]) {\r\n\t\t\t\tstyles.weight = feature.properties[\"stroke-width\"] * 1.05;\r\n\t\t\t}\r\n\t\t\tif (feature.properties[\"stroke-opacity\"]) {\r\n\t\t\t\tstyles.opacity = feature.properties[\"stroke-opacity\"];\r\n\t\t\t}\r\n\t\t\tif (feature.properties[\"fill-opacity\"]) {\r\n\t\t\t\tstyles.fillOpacity = feature.properties[\"fill-opacity\"];\r\n\t\t\t}\r\n\t\t\tif (feature.properties.stroke) {\r\n\t\t\t\tstyles.color = feature.properties.stroke;\r\n\t\t\t}\r\n\t\t\tif (feature.properties.fill) {\r\n\t\t\t\tstyles.fillColor = feature.properties.fill;\r\n\t\t\t}\r\n\t\t}\r\n\t\tlayer.setStyle(styles);\r\n\t},\r\n\r\n\t_setLayerBalloon: function(feature, layer) {\r\n\t\tif (!this.options.ballon) return;\r\n\r\n\t\tvar name = feature.properties.name ? feature.properties.name : \"\";\r\n\t\tvar desc = feature.properties.description ? feature.properties.description : \"\";\r\n\r\n\t\tif (name || desc) {\r\n\t\t\tif (this.options.bindPopup) {\r\n\t\t\t\tlayer.bindPopup('<div>' + '<b>' + name + '</b>' + '<br>' + desc + '</div>');\r\n\t\t\t}\r\n\t\t\tif (this.options.bindTooltip) {\r\n\t\t\t\tlayer.bindTooltip('<b>' + name + '</b>', {\r\n\t\t\t\t\tdirection: 'auto',\r\n\t\t\t\t\tsticky: true,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\r\n\t_escapeRegExp: function(str) {\r\n\t\treturn str.replace(/([.*+?^=!:${}()|\\[\\]\\/\\\\])/g, \"\\\\$1\");\r\n\t},\r\n\r\n\t_replaceAll: function(str, find, replace) {\r\n\t\treturn str.replace(new RegExp(this._escapeRegExp(find), 'g'), replace);\r\n\t},\r\n\r\n\t_mapZipFiles: function(zip) {\r\n\t\treturn Object.keys(zip.files)\r\n\t\t\t.map((name) => zip.files[name])\r\n\t\t\t.map((entry) => entry\r\n\t\t\t\t.async(\"blob\")\r\n\t\t\t\t.then((value) => [entry.name, value]) // [ fileName, stringValue ]\r\n\t\t\t);\r\n\t},\r\n\r\n\t_mapListFiles: function(list) {\r\n\t\treturn list.map(file => Promise.resolve().then(() => {\r\n\t\t\treturn this._readFile(file);\r\n\t\t}));\r\n\t},\r\n\r\n\t_listToObject: function(list) {\r\n\t\treturn list\r\n\t\t\t.reduce(function(newObj, listElem) {\r\n\t\t\t\tnewObj[listElem[0]] = listElem[1]; // { fileName: stringValue }\r\n\t\t\t\treturn newObj;\r\n\t\t\t}, {} /* NB: do not remove, initial value */ );\r\n\t},\r\n\r\n\t_getFileExt: function(filename) {\r\n\t\treturn filename.split('.').pop().toLowerCase().replace('jpg', 'jpeg');\r\n\t},\r\n\r\n\t_getMimeType: function(filename, ext) {\r\n\t\tvar mime = 'text/plain';\r\n\t\tif (/\\.(jpe?g|png|gif|bmp)$/i.test(filename)) {\r\n\t\t\tmime = 'image/' + ext;\r\n\t\t} else if (/\\.kml$/i.test(filename)) {\r\n\t\t\tmime = 'text/plain';\r\n\t\t}\r\n\t\treturn mime;\r\n\t},\r\n\r\n\t_getKmlDoc: function(files) {\r\n\t\treturn files[\"doc.kml\"] ? \"doc.kml\" : this._getKmlFiles(Object.keys(files))[0];\r\n\t},\r\n\r\n\t_getKmlFiles: function(files) {\r\n\t\treturn files.filter((file) => /.*\\.kml/.test(file));\r\n\t},\r\n\r\n\t_getImageFiles: function(files) {\r\n\t\treturn files.filter((file) => /\\.(jpe?g|png|gif|bmp)$/i.test(file));\r\n\t},\r\n\r\n\t/**\r\n\t * It checks if a given file begins with PK, if so it's zipped\r\n\t *\r\n\t * @link https://en.wikipedia.org/wiki/List_of_file_signatures\r\n\t */\r\n\t_isZipped: function(file) {\r\n\t\tvar P = new Uint8Array(file, 0, 1); // offset, length\r\n\t\tvar K = new Uint8Array(file, 1, 1);\r\n\t\tvar PK = String.fromCharCode(P, K);\r\n\t\treturn 'PK' === PK;\r\n\t},\r\n\r\n\t_readFile: function(file) {\r\n\t\tvar filename = file[0];\r\n\t\tvar fileblob = file[1];\r\n\t\tvar ext = this._getFileExt(filename);\r\n\t\tvar mime = this._getMimeType(filename, ext);\r\n\t\treturn this._fileReader(fileblob, mime, filename);\r\n\t},\r\n\r\n\t_fileReader: function(blob, mime, name) {\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tvar fr = new FileReader();\r\n\t\t\tfr.onload = () => {\r\n\t\t\t\tvar result = fr.result;\r\n\t\t\t\tif (mime.indexOf('text') === -1) {\r\n\t\t\t\t\tvar dataUrl = fr.result;\r\n\t\t\t\t\tvar base64 = dataUrl.split(',')[1];\r\n\t\t\t\t\tresult = 'data:' + mime + ';base64,' + base64;\r\n\t\t\t\t}\r\n\t\t\t\treturn resolve([\r\n\t\t\t\t\tname, result\r\n\t\t\t\t]);\r\n\t\t\t};\r\n\t\t\tif (mime.indexOf('text') === -1) {\r\n\t\t\t\tfr.readAsDataURL(blob);\r\n\t\t\t} else {\r\n\t\t\t\tfr.readAsText(blob);\r\n\t\t\t}\r\n\t\t});\r\n\t},\r\n\r\n\t_getBinaryContent: function(path, callback) {\r\n\t\ttry {\r\n\t\t\tvar xhr = new window.XMLHttpRequest();\r\n\t\t\txhr.open('GET', path, true);\r\n\t\t\txhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');\r\n\t\t\txhr.responseType = \"arraybuffer\";\r\n\t\t\txhr.onreadystatechange = function(evt) {\r\n\t\t\t\tvar file, err;\r\n\t\t\t\tif (xhr.readyState === 4) {\r\n\t\t\t\t\tif (xhr.status === 200 || xhr.status === 0) {\r\n\t\t\t\t\t\tfile = null;\r\n\t\t\t\t\t\terr = null;\r\n\t\t\t\t\t\ttry {\r\n\t\t\t\t\t\t\tfile = xhr.response || xhr.responseText;\r\n\t\t\t\t\t\t} catch (e) {\r\n\t\t\t\t\t\t\terr = new Error(e);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tcallback(err, file);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tcallback(new Error(\"Ajax error for \" + path + \" : \" + this.status + \" \" + this.statusText), null);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\txhr.send();\r\n\t\t} catch (e) {\r\n\t\t\tcallback(new Error(e), null);\r\n\t\t}\r\n\t},\r\n\r\n\t_blobToString: function(b) {\r\n\t\tvar u, x;\r\n\t\tu = URL.createObjectURL(b);\r\n\t\tx = new XMLHttpRequest();\r\n\t\tx.open('GET', u, false); // although sync, you're not fetching over internet\r\n\t\tx.send();\r\n\t\tURL.revokeObjectURL(u);\r\n\t\treturn x.responseText;\r\n\t},\r\n\r\n\t_blobToBase64: function(blob, callback) {\r\n\t\tvar reader = new FileReader();\r\n\t\treader.onload = function() {\r\n\t\t\tvar dataUrl = reader.result;\r\n\t\t\tvar base64 = dataUrl.split(',')[1];\r\n\t\t\tcallback(base64);\r\n\t\t};\r\n\t\treader.readAsDataURL(blob);\r\n\t},\r\n\r\n});\r\n\r\nexport var KMZLoader = L.KMZLoader;\r\n","/**\r\n * Optimized leaflet canvas renderer to load numerous markers\r\n *\r\n * @link https://stackoverflow.com/a/51852641\r\n * @link https://stackoverflow.com/a/43019740\r\n *\r\n */\r\nL.KMZMarker = L.CircleMarker.extend({\r\n\tsetIconUrl: function(iconUrl) {\r\n\t\tthis._iconUrl = typeof iconUrl !== \"undefined\" ? iconUrl : this._iconUrl;\r\n\t},\r\n\t_updatePath: function() {\r\n\t\tvar renderer = this._renderer;\r\n\t\tvar layer = this;\r\n\r\n\t\tif (!this._iconUrl || !renderer._drawing || layer._empty()) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar p = layer._point,\r\n\t\t\tctx = renderer._ctx;\r\n\r\n\t\tvar icon = new Image(),\r\n\t\t\twidth = 28,\r\n\t\t\theight = 28;\r\n\r\n\t\ticon.onload = function() {\r\n\t\t\tctx.drawImage(icon, p.x - (width / 2.0), p.y - (height / 2.0), width, height);\r\n\t\t\trenderer._drawnLayers[layer._leaflet_id] = layer;\r\n\t\t};\r\n\t\ticon.src = this._iconUrl;\r\n\t}\r\n});\r\n\r\nexport var KMZMarker = L.KMZMarker;\r\n","/**\r\n * A plugin combining geojson-vt with leafletjs which is initially inspired by leaflet-geojson-vt.\r\n *\r\n * @author Brandonxiang, Raruto\r\n *\r\n * @link https://github.com/brandonxiang/leaflet-geojson-vt\r\n */\r\n\r\n// import geojsonvt from 'geojson-vt';\r\nimport 'leaflet-pointable';\r\n\r\nL.GridLayer.GeoJSON = L.GridLayer.extend({\r\n  options: {\r\n    pointable: false,\r\n    ballon: false,\r\n    bindPopup: false,\r\n    bindTooltip: false,\r\n    async: false,\r\n    maxZoom: 24,\r\n    tolerance: 3,\r\n    debug: 0,\r\n    extent: 4096,\r\n    buffer: 256,\r\n    icon: {\r\n      width: 28,\r\n      height: 28\r\n    },\r\n    styles: {\r\n      strokeWidth: 1,\r\n      strokeColor: '#f00',\r\n      strokeOpacity: 1.0,\r\n      fillColor: '#000',\r\n      fillOpacity: 0.25\r\n    }\r\n  },\r\n\r\n  initialize: function(geojson, options) {\r\n    L.setOptions(this, options);\r\n    L.GridLayer.prototype.initialize.call(this, options);\r\n    this.tileIndex = (geojsonvt || window.geojsonvt)(geojson, this.options);\r\n    this.geojson = geojson; // eg. saved for advanced \"leaflet-pip\" mouse/click integrations\r\n  },\r\n\r\n  onAdd: function(map) {\r\n    L.GridLayer.prototype.onAdd.call(this, map);\r\n    if (this.options.ballon) {\r\n      if (this.options.bindPopup) this._map.on(\"click\", this.updateBalloon, this);\r\n      if (this.options.bindTooltip) this._map.on(\"mousemove\", this.updateBalloon, this);\r\n    }\r\n  },\r\n\r\n  createTile: function(coords) {\r\n    var tile = L.DomUtil.create('canvas', 'leaflet-tile');\r\n    var size = this.getTileSize();\r\n    tile.width = size.x;\r\n    tile.height = size.y;\r\n    var ctx = tile.getContext('2d');\r\n\r\n    // return the tile so it can be rendered on screen\r\n    var tileInfo = this.tileIndex.getTile(coords.z, coords.x, coords.y);\r\n    var features = tileInfo ? tileInfo.features : [];\r\n    for (var i = 0; i < features.length; i++) {\r\n      this._drawFeature(ctx, features[i]);\r\n    }\r\n    return tile;\r\n  },\r\n\r\n  _drawFeature: function(ctx, feature) {\r\n    ctx.beginPath();\r\n    this._setStyle(ctx, feature);\r\n\r\n    if (feature.type === 1) this._drawIcon(ctx, feature);\r\n    else if (feature.type === 2) this._drawLine(ctx, feature);\r\n    else if (feature.type === 3) this._drawPolygon(ctx, feature);\r\n    else console.warn('Unsupported feature type: ' + feature.geometry.type, feature);\r\n\r\n    ctx.stroke();\r\n  },\r\n\r\n  _drawIcon: function(ctx, feature) {\r\n    var icon = new Image(),\r\n      p = feature.geometry[0],\r\n      width = this.options.icon.width,\r\n      height = this.options.icon.height;\r\n    icon.onload = function() {\r\n      ctx.drawImage(icon, (p[0] / 16.0) - (width / 2.0), (p[1] / 16.0) - (height / 2.0), width, height);\r\n    };\r\n    icon.src = feature.tags.icon ? feature.tags.icon : null;\r\n  },\r\n\r\n  _drawLine: function(ctx, feature) {\r\n    for (var j = 0; j < feature.geometry.length; j++) {\r\n      var ring = feature.geometry[j];\r\n      for (var k = 0; k < ring.length; k++) {\r\n        var p = ring[k];\r\n        if (k) ctx.lineTo(p[0] / 16.0, p[1] / 16.0);\r\n        else ctx.moveTo(p[0] / 16.0, p[1] / 16.0);\r\n      }\r\n    }\r\n  },\r\n\r\n  _drawPolygon: function(ctx, feature) {\r\n    this._drawLine(ctx, feature);\r\n    ctx.fill('evenodd');\r\n  },\r\n\r\n  _setStyle: function(ctx, feature) {\r\n    var style = {};\r\n\r\n    if (feature.type === 1) style = this._setPointStyle(feature, style);\r\n    else if (feature.type === 2) style = this._setLineStyle(feature, style);\r\n    else if (feature.type === 3) style = this._setPolygonStyle(feature, style);\r\n\r\n    ctx.lineWidth = style.stroke ? this._setWeight(style.weight) : 0;\r\n    ctx.strokeStyle = style.stroke ? this._setOpacity(style.stroke, style.opacity) : {};\r\n    ctx.fillStyle = style.fill ? this._setOpacity(style.fill, style.fillOpacity) : {};\r\n  },\r\n\r\n  _setPointStyle: function(feature, style) {\r\n    return style;\r\n  },\r\n\r\n  _setLineStyle: function(feature, style) {\r\n    style.weight = (feature.tags[\"stroke-width\"] ? feature.tags[\"stroke-width\"] : this.options.styles.strokeWidth) * 1.05;\r\n    style.opacity = feature.tags[\"stroke-opacity\"] ? feature.tags[\"stroke-opacity\"] : this.options.styles.strokeOpacity;\r\n    style.stroke = feature.tags.stroke ? feature.tags.stroke : this.options.styles.strokeColor;\r\n    return style;\r\n  },\r\n\r\n  _setPolygonStyle: function(feature, style) {\r\n    style = this._setLineStyle(feature, style);\r\n    style.fill = feature.tags.fill ? feature.tags.fill : this.options.styles.fillColor;\r\n    style.fillOpacity = feature.tags[\"fill-opacity\"] ? feature.tags[\"fill-opacity\"] : this.options.styles.fillOpacity;\r\n    return style;\r\n  },\r\n\r\n  _setWeight: function(weight) {\r\n    return weight || 5;\r\n  },\r\n\r\n  _setOpacity: function(color, opacity) {\r\n    color = color || '#f00';\r\n    if (opacity && this._iscolorHex(color)) {\r\n      var colorRgb = this._colorRgb(color);\r\n      return \"rgba(\" + colorRgb[0] + \",\" + colorRgb[1] + \",\" + colorRgb[2] + \",\" + opacity + \")\";\r\n    }\r\n    return color;\r\n  },\r\n\r\n  _iscolorHex: function(color) {\r\n    return /^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(color.toLowerCase());\r\n  },\r\n\r\n  _colorRgb: function(color) {\r\n    var sColor = color.toLowerCase();\r\n    if (sColor.length === 4) {\r\n      var sColorNew = \"#\";\r\n      for (var i = 1; i < 4; i += 1) {\r\n        sColorNew += sColor.slice(i, i + 1).concat(sColor.slice(i, i + 1));\r\n      }\r\n      sColor = sColorNew;\r\n    }\r\n    var sColorChange = [];\r\n    for (var j = 1; j < 7; j += 2) {\r\n      sColorChange.push(parseInt(\"0x\" + sColor.slice(j, j + 2)));\r\n    }\r\n    return sColorChange;\r\n  },\r\n\r\n  /**\r\n   * Point in Polygon: ray-casting algorithm\r\n   *\r\n   * @link http://www.ecse.rpi.edu/Homepages/wrf/Research/Short_Notes/pnpoly.html\r\n   */\r\n  _pointInPolygon: function(point, vs) {\r\n    var x = point[0];\r\n    var y = point[1];\r\n\r\n    var inside = false;\r\n    for (var i = 0, j = vs.length - 1; i < vs.length; j = i++) {\r\n      var xi = vs[i][0];\r\n      var yi = vs[i][1];\r\n      var xj = vs[j][0];\r\n      var yj = vs[j][1];\r\n\r\n      var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);\r\n      if (intersect) inside = !inside;\r\n    }\r\n\r\n    return inside;\r\n  },\r\n\r\n  _getLatLngsPoly: function(feature, i) {\r\n    var o = [];\r\n    var geometry = feature.geometry || feature;\r\n    var coords = geometry.type == \"Polygon\" ? geometry.coordinates[0] : geometry.coordinates;\r\n    for (var j = i || 0; j < coords.length; j++) {\r\n      o[i++] = [coords[j][0], coords[j][1]];\r\n    }\r\n    return o.length ? o : false;\r\n  },\r\n\r\n  _getLatLngsPoint: function(feature, i) {\r\n    var o = [];\r\n    var geometry = feature.geometry || feature;\r\n    var coords = geometry.coordinates;\r\n    o[i || 0] = [coords[0], coords[1]];\r\n    return o.length ? o : false;\r\n  },\r\n\r\n  _getLatLngs: function(feature, i) {\r\n    var o = [];\r\n    i = i || 0;\r\n    var coords;\r\n\r\n    var geometry = feature.geometry || feature;\r\n    var type = geometry.type;\r\n\r\n    if (type == \"Point\") {\r\n      coords = this._getLatLngsPoint(feature, i);\r\n      if (coords) Array.prototype.push.apply(o, coords);\r\n    } else if (type == \"LineString\" || type == \"Polygon\") {\r\n      coords = this._getLatLngsPoly(feature, i);\r\n      if (coords) Array.prototype.push.apply(o, coords);\r\n    } else if (type == \"GeometryCollection\") {\r\n      var polys = geometry.geometries;\r\n      for (var j = 0; j < polys.length; j++) {\r\n        coords = this._getLatLngs(polys[j], i);\r\n        if (coords) Array.prototype.push.apply(o, coords);\r\n      }\r\n    } else {\r\n      console.warn(\"Unsupported feature type: \" + type);\r\n    }\r\n    return o.length ? o : false;\r\n  },\r\n\r\n  /**\r\n   * (EXPERIMENTAL) Inspired by: https://github.com/mapbox/leaflet-pip\r\n   *\r\n   * TODO: add/check support for Points, Lines and \"donuts\" Polygons\r\n   */\r\n  pointInLayer: function(p, layer, first) {\r\n    if (p instanceof L.LatLng) p = [p.lng, p.lat];\r\n    var results = [];\r\n\r\n    layer = layer || this.geojson;\r\n    first = first || true;\r\n    var features = layer.features;\r\n\r\n    for (var i = 0; i < features.length; i++) {\r\n      if (first && results.length) break;\r\n      var coords = this._getLatLngs(features[i]);\r\n      if (coords) {\r\n        var inside = this._pointInPolygon(p, coords); // NB. works only with polygons (see: https://observablehq.com/@tmcw/understanding-point-in-polygon).\r\n        if (inside) results.push(features[i]);\r\n      }\r\n    }\r\n    return results.length ? results : false;\r\n  },\r\n\r\n  /**\r\n   * (EXPERIMENTAL) Inspired by: https://github.com/Raruto/leaflet-pointable\r\n   */\r\n  updateBalloon: function(e) {\r\n    if (!this._map || !this.options.pointable || !this._map.isPointablePixel() || !this.isPointablePixel()) return;\r\n    this._popup = this._popup || new L.Popup();\r\n    var points = this.pointInLayer(e.latlng, this.geojson);\r\n    if (points) {\r\n      var feature = points[0];\r\n      var name = feature.properties.name || \"\";\r\n      if (name) {\r\n        this._popup.setLatLng(e.latlng);\r\n        this._popup.setContent('<b>' + name + '</b>');\r\n        this._popup.openOn(this._map);\r\n      }\r\n    } else {\r\n      this._map.closePopup(this._popup);\r\n    }\r\n  },\r\n\r\n});\r\n\r\nL.gridLayer.geoJson = function(geojson, options) {\r\n  return new L.GridLayer.GeoJSON(geojson, options);\r\n};\r\n\r\nexport var GridLayer = {\r\n  GeoJSON: L.GridLayer.GeoJSON,\r\n};\r\n\r\nexport var gridLayer = {\r\n  geoJSON: L.gridLayer.geoJson,\r\n};\r\n"],"names":["L","KMZParser","Class","extend","initialize","opts","setOptions","this","loaders","load","kmzUrl","_loadAsyncJS","_requiredJSModules","_waitAsyncJS","_loadKMZ","bind","get","i","length","kmzLoader","KMZLoader","options","parse","push","urls","_jsPromise","promises","map","url","_loadJS","_jsPromisePending","Promise","all","then","resolve","reject","tag","document","createElement","type","src","onload","onerror","head","appendChild","host","JSZip","window","toGeoJSON","geojsonvt","callback","call","tiled","interactive","ballon","bindPopup","bindTooltip","debug","keepFront","pointable","emptyIcon","name","onKMZLoaded","_pointRenderer","canvas","padding","pane","split","pop","_load","_getBinaryContent","err","data","console","error","_parse","_isZipped","_parseKMZ","_parseKML","that","loadAsync","zip","_mapZipFiles","list","_mapListFiles","kmlString","_decodeKMZFolder","_decodeKMLString","xmlDoc","_toXML","_kmlToLayer","ArrayBuffer","String","fromCharCode","apply","Uint8Array","kmzFiles","_listToObject","kmlDoc","_getKmlDoc","images","_getImageFiles","Object","keys","imageUrl","dataUrl","_replaceAll","text","DOMParser","parseFromString","_toGeoJSON","kml","_keepFront","layer","e","bringToFront","on","_map","off","geojson","geoJson","pointToLayer","_pointToLayer","onEachFeature","_onEachFeature","gridlayer","gridLayer","featureGroup","_onKMZLoaded","feature","latlng","KMZMarker","renderer","geometry","_setLayerPointIcon","_setLayerStyle","warn","_setLayerBalloon","log","setIconUrl","properties","icon","styles","weight","opacity","fillOpacity","stroke","color","fill","fillColor","setStyle","desc","description","direction","sticky","_escapeRegExp","str","replace","find","RegExp","files","entry","async","value","file","_readFile","reduce","newObj","listElem","_getFileExt","filename","toLowerCase","_getMimeType","ext","mime","test","_getKmlFiles","filter","P","K","fileblob","_fileReader","blob","fr","FileReader","result","indexOf","base64","readAsDataURL","readAsText","path","xhr","XMLHttpRequest","open","setRequestHeader","responseType","onreadystatechange","evt","readyState","status","response","responseText","Error","statusText","send","_blobToString","b","u","x","URL","createObjectURL","revokeObjectURL","_blobToBase64","reader","CircleMarker","iconUrl","_iconUrl","_updatePath","_renderer","_drawing","_empty","p","_point","ctx","_ctx","Image","drawImage","y","_drawnLayers","_leaflet_id","GridLayer","GeoJSON","maxZoom","tolerance","extent","buffer","width","height","strokeWidth","strokeColor","strokeOpacity","prototype","tileIndex","onAdd","updateBalloon","createTile","coords","tile","DomUtil","create","size","getTileSize","getContext","tileInfo","getTile","z","features","_drawFeature","beginPath","_setStyle","_drawIcon","_drawLine","_drawPolygon","tags","j","ring","k","lineTo","moveTo","style","_setPointStyle","_setLineStyle","_setPolygonStyle","lineWidth","_setWeight","strokeStyle","_setOpacity","fillStyle","_iscolorHex","colorRgb","_colorRgb","sColor","sColorNew","slice","concat","sColorChange","parseInt","_pointInPolygon","point","vs","inside","xi","yi","xj","yj","_getLatLngsPoly","o","coordinates","_getLatLngsPoint","_getLatLngs","Array","polys","geometries","pointInLayer","first","LatLng","lng","lat","results","isPointablePixel","_popup","Popup","points","setLatLng","setContent","openOn","closePopup","geoJSON"],"mappings":"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"}