!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("leaflet-pointable")):"function"==typeof define&&define.amd?define(["exports","leaflet-pointable"],t):t((e=e||self)["leaflet-kmz"]={})}(this,(function(e){"use strict";const t=(e,t)=>{try{var i=new window.XMLHttpRequest;i.open("GET",e,!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.responseType="arraybuffer",i.onreadystatechange=function(o){var n,r;if(4===i.readyState)if(200===i.status||0===i.status){n=null,r=null;try{n=i.response||i.responseText}catch(e){r=new Error(e)}t(r,n)}else t(new Error("Ajax error for "+e+" : "+this.status+" "+this.statusText),null)},i.send()}catch(e){t(new Error(e),null)}},i=e=>e["doc.kml"]?"doc.kml":o(Object.keys(e))[0],o=e=>e.filter(e=>/.*\.kml/.test(e)),n=e=>e.filter(e=>/\.(jpe?g|png|gif|bmp)$/i.test(e)),r=(e,t)=>{var i,o=[];t=t||0;var n=e.geometry||e,s=n.type;if("Point"==s)(i=((e,t)=>{var i=[],o=(e.geometry||e).coordinates;return i[t||0]=[o[0],o[1]],!!i.length&&i})(e,t))&&o.push(i);else if("LineString"==s||"Polygon"==s)(i=((e,t)=>{for(var i=[],o=e.geometry||e,n="Polygon"==o.type?o.coordinates[0]:o.coordinates,r=t||0;r<n.length;r++)i[t++]=[n[r][0],n[r][1]];return!!i.length&&i})(e,t))&&o.push(i);else if("GeometryCollection"==s)for(var a=n.geometries,l=0;l<a.length;l++)(i=r(a[l],t))&&o.push(i);else console.warn("Unsupported feature type: "+s);return!!o.length&&o},s=e=>e.reduce((e,t)=>(e[t[0]]=t[1],e),{}),a=e=>new Promise((t,o)=>{Promise.all((e=>Object.keys(e.files).map(t=>e.files[t]).map(e=>e.async("blob").then(t=>[e.name,t])))(e)).then(e=>{Promise.all((e=>e.map(e=>Promise.resolve().then(()=>p(e))))(e)).then(e=>t((e=>{var t=s(e),o=i(t),r=n(Object.keys(t)),a=t[o];for(var l in r){var p=r[l],d=t[p];a=h(a,p,d)}return a})(e)))})}),l=(e,t)=>{for(var i=e[0],o=e[1],n=!1,r=0,s=t.length-1;r<t.length;s=r++){var a=t[r][0],l=t[r][1],p=t[s][0],h=t[s][1];l>o!=h>o&&i<(p-a)*(o-l)/(h-l)+a&&(n=!n)}return n},p=e=>{var t=e[0],i=e[1],o=(e=>e.split(".").pop().toLowerCase().replace("jpg","jpeg"))(t);return((e,t,i)=>new Promise((o,n)=>{var r=new FileReader;r.onload=()=>{var e=r.result;if(-1===t.indexOf("text")){var n=r.result.split(",")[1];e="data:"+t+";base64,"+n}return o([i,e])},-1===t.indexOf("text")?r.readAsDataURL(e):r.readAsText(e)}))(i,((e,t)=>{var i="text/plain";return/\.(jpe?g|png|gif|bmp)$/i.test(e)?i="image/"+t:/\.kml$/i.test(e)&&(i="text/plain"),i})(t,o),t)},h=(e,t,i)=>e.replace(new RegExp((e=>e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1"))(t),"g"),i),d=(e,t)=>{if(t&&(e=>/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(e.toLowerCase()))(e)){var i=(e=>{var t=e.toLowerCase();if(4===t.length){for(var i="#",o=1;o<4;o+=1)i+=t.slice(o,o+1).concat(t.slice(o,o+1));t=i}for(var n=[],r=1;r<7;r+=2)n.push(parseInt("0x"+t.slice(r,r+2)));return n})(e);return"rgba("+i[0]+","+i[1]+","+i[2]+","+t+")"}return e};L.KMZParser=L.Class.extend({initialize:function(e){L.setOptions(this,e),this.loaders=[]},load:function(e,t){this._loadAsyncJS(this._requiredJSModules()),this._waitAsyncJS(this._loadKMZ.bind(this,e,t))},get:function(e){return e<this.loaders.length&&this.loaders[e]},_loadKMZ:function(e,t){var i=new L.KMZLoader(L.extend({},this.options,t));i.parse(e),this.loaders.push(i)},_loadAsyncJS:function(e){if(!L.KMZParser._jsPromise&&e.length){var t=e.map(e=>(e=>new Promise((t,i)=>{var o=document.createElement("script");o.type="text/javascript",o.src=e,o.onload=t.bind(e),o.onerror=i.bind(e),document.head.appendChild(o)}))(e));L.KMZParser._jsPromisePending=!0,L.KMZParser._jsPromise=Promise.all(t).then(function(){L.KMZParser._jsPromisePending=!1}.bind(this))}},_requiredJSModules:function(){var e=[],t="https://unpkg.com/";return"function"!=typeof window.JSZip&&e.push(t+"jszip@3.1.5/dist/jszip.min.js"),"object"!=typeof window.toGeoJSON&&e.push(t+"@tmcw/togeojson@3.0.1/dist/togeojsons.min.js"),"function"!=typeof window.geojsonvt&&e.push(t+"geojson-vt@3.0.0/geojson-vt.js"),e},_waitAsyncJS:function(e){L.KMZParser._jsPromise&&L.KMZParser._jsPromisePending?L.KMZParser._jsPromise.then(e):e.call()}});var c=L.KMZParser;L.KMZLoader=L.Class.extend({options:{renderer:!0,tiled:!0,interactive:!0,ballon:!0,bindPopup:!0,bindTooltip:!0,debug:0,keepFront:!0,emptyIcon:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAFElEQVR4XgXAAQ0AAABAMP1L30IDCPwC/o5WcS4AAAAASUVORK5CYII="},initialize:function(e){L.setOptions(this,e),this.renderer=this.options.renderer,this.tiled=this.options.tiled,this.interactive=this.options.interactive,this.pointable=this.tiled&&!this.interactive&&this.options.pointable,this.emptyIcon=this.options.emptyIcon,this.name=this.options.name,this.callback=e.onKMZLoaded},parse:function(e){this.name=this.name?this.name:e.split("/").pop(),this._load(e)},_load:function(e){t(e,(t,i)=>{null!=t?console.error(e,t,i):this._parse(i)})},_parse:function(e){return t=e,i=new Uint8Array(t,0,1),o=new Uint8Array(t,1,1),"PK"===String.fromCharCode(i,o)?this._parseKMZ(e):this._parseKML(e);var t,i,o},_parseKMZ:function(e){(e=>new Promise((t,i)=>{window.JSZip.loadAsync(e).then(e=>a(e).then(e=>t(e)))}))(e).then(e=>this._parseKML(e))},_parseKML:function(e){var t,i=(e=>e instanceof ArrayBuffer?String.fromCharCode.apply(null,new Uint8Array(e)):e)(e),o=(t=i,(new DOMParser).parseFromString(t,"text/xml"));this._kmlToLayer(o)},_keepFront:function(e){var t=function(e){this.bringToFront&&this.bringToFront()}.bind(e);e.on("add",(function(e){this._map.on("baselayerchange",t)})),e.on("remove",(function(e){this._map.off("baselayerchange",t)}))},_kmlToLayer:function(e){var t=(e=>window.toGeoJSON.kml(e))(e);this.interactive&&(this.geojson=L.geoJson(t,{pointToLayer:this._pointToLayer.bind(this),onEachFeature:this._onEachFeature.bind(this),kmzRenderer:this.renderer}),this.layer=this.geojson),this.tiled&&(this.gridlayer=L.gridLayer.geoJson(t,{pointable:this.pointable,ballon:this.options.ballon,bindPopup:this.options.bindPopup,bindTooltip:this.options.bindTooltip}),this.layer=this.interactive?L.featureGroup([this.gridlayer,this.geojson]):this.gridlayer),this.layer&&this._onKMZLoaded(this.layer,this.name)},_pointToLayer:function(e,t){return new L.KMZMarker(t,{kmzRenderer:this.renderer})},_onEachFeature:function(e,t){switch(e.geometry.type){case"Point":this._setLayerPointIcon(e,t);break;case"LineString":case"Polygon":case"GeometryCollection":this._setLayerStyle(e,t);break;default:console.warn("Unsupported feature type: "+e.geometry.type,e)}this._setLayerBalloon(e,t)},_onKMZLoaded:function(e,t){this.options.debug&&console.log(e,t),this.options.keepFront&&this._keepFront(e),this.callback&&this.callback(e,t)},_setLayerPointIcon:function(e,t){t.setIconUrl(this.tiled?this.emptyIcon:e.properties.icon)},_setLayerStyle:function(e,t){var i={weight:1,opacity:0,fillOpacity:0};this.tiled||(e.properties["stroke-width"]&&(i.weight=1.05*e.properties["stroke-width"]),e.properties["stroke-opacity"]&&(i.opacity=e.properties["stroke-opacity"]),e.properties["fill-opacity"]&&(i.fillOpacity=e.properties["fill-opacity"]),e.properties.stroke&&(i.color=e.properties.stroke),e.properties.fill&&(i.fillColor=e.properties.fill)),t.setStyle(i)},_setLayerBalloon:function(e,t){if(this.options.ballon){var i=e.properties.name?e.properties.name:"",o=e.properties.description?e.properties.description:"";(i||o)&&(this.options.bindPopup&&t.bindPopup("<div><b>"+i+"</b><br>"+o+"</div>"),this.options.bindTooltip&&t.bindTooltip("<b>"+i+"</b>",{direction:"auto",sticky:!0}))}}});var u=L.Map.prototype.getRenderer;L.Map.addInitHook((function(){this.options.kmzRenderer=L.canvas({padding:.5})})),L.Map.include({getRenderer:function(e){return e&&e.options&&e.options.kmzRenderer&&(e.options.kmzRenderer instanceof L.Renderer?e.options.renderer=e.options.kmzRenderer:e.options.kmzRenderer&&(e.options.renderer=this.options.kmzRenderer)),u.call(this,e)}});var f=L.KMZLoader;L.KMZMarker=L.CircleMarker.extend({setIconUrl:function(e){this._iconUrl=void 0!==e?e:this._iconUrl},_updatePath:function(){var e=this._renderer,t=this;if(this._iconUrl&&e._drawing&&!t._empty()){var i=t._point,o=e._ctx,n=new Image;n.onload=function(){o.drawImage(n,i.x-14,i.y-14,28,28),e._drawnLayers?e._drawnLayers[t._leaflet_id]=t:e._layers[t._leaflet_id]=t},n.src=this._iconUrl}}});var y=L.KMZMarker;L.GridLayer.GeoJSON=L.GridLayer.extend({options:{pointable:!1,ballon:!1,bindPopup:!1,bindTooltip:!1,async:!1,maxZoom:24,tolerance:3,debug:0,extent:4096,buffer:256,icon:{width:28,height:28},styles:{strokeWidth:1,strokeColor:"#f00",strokeOpacity:1,fillColor:"#000",fillOpacity:.25}},initialize:function(e,t){L.setOptions(this,t),L.GridLayer.prototype.initialize.call(this,t),this.tileIndex=(geojsonvt||window.geojsonvt)(e,this.options),this.geojson=e},onAdd:function(e){L.GridLayer.prototype.onAdd.call(this,e),this.options.ballon&&(this.options.bindPopup&&this._map.on("click",this.updateBalloon,this),this.options.bindTooltip&&this._map.on("mousemove",this.updateBalloon,this))},createTile:function(e){var t=L.DomUtil.create("canvas","leaflet-tile"),i=this.getTileSize();t.width=i.x,t.height=i.y;for(var o=t.getContext("2d"),n=this.tileIndex.getTile(e.z,e.x,e.y),r=n?n.features:[],s=0;s<r.length;s++)this._drawFeature(o,r[s]);return t},_drawFeature:function(e,t){e.beginPath(),this._setStyle(e,t),1===t.type?this._drawIcon(e,t):2===t.type?this._drawLine(e,t):3===t.type?this._drawPolygon(e,t):console.warn("Unsupported feature type: "+t.geometry.type,t),e.stroke()},_drawIcon:function(e,t){var i=new Image,o=t.geometry[0],n=this.options.icon.width,r=this.options.icon.height;i.onload=()=>e.drawImage(i,o[0]/16-n/2,o[1]/16-r/2,n,r),i.src=t.tags.icon?t.tags.icon:null},_drawLine:function(e,t){var i,o,n,r,s=t.geometry;for(n=0;n<s.length;n++)for(i=s[n],r=0;r<i.length;r++)o=i[r],r?e.lineTo(o[0]/16,o[1]/16):e.moveTo(o[0]/16,o[1]/16)},_drawPolygon:function(e,t){this._drawLine(e,t),e.fill("evenodd")},_setStyle:function(e,t){var i={};1===t.type?i=this._setPointStyle(t,i):2===t.type?i=this._setLineStyle(t,i):3===t.type&&(i=this._setPolygonStyle(t,i)),e.lineWidth=i.stroke?this._setWeight(i.weight):0,e.strokeStyle=i.stroke?this._setOpacity(i.stroke,i.opacity):{},e.fillStyle=i.fill?this._setOpacity(i.fill,i.fillOpacity):{}},_setPointStyle:function(e,t){return t},_setLineStyle:function(e,t){return t.weight=1.05*(e.tags["stroke-width"]?e.tags["stroke-width"]:this.options.styles.strokeWidth),t.opacity=e.tags["stroke-opacity"]?e.tags["stroke-opacity"]:this.options.styles.strokeOpacity,t.stroke=e.tags.stroke?e.tags.stroke:this.options.styles.strokeColor,t},_setPolygonStyle:function(e,t){return(t=this._setLineStyle(e,t)).fill=e.tags.fill?e.tags.fill:this.options.styles.fillColor,t.fillOpacity=e.tags["fill-opacity"]?e.tags["fill-opacity"]:this.options.styles.fillOpacity,t},_setWeight:function(e){return e||5},_setOpacity:function(e,t){return d(e||"#f00",t)},updateBalloon:function(e){if(this._map&&this.options.pointable&&this._map.isPointablePixel()&&this.isPointablePixel()){this._popup=this._popup||L.popup();var t=((e,t,i)=>{e instanceof L.LatLng&&(e=[e.lng,e.lat]);var o=[];i=i||!0;for(var n=t.features,s=0;s<n.length&&(!i||!o.length);s++){var a=r(n[s]);a&&l(e,a)&&o.push(n[s])}return!!o.length&&o})(e.latlng,this.geojson);if(t){var i=t[0].properties.name||"";i&&(this._popup.setLatLng(e.latlng),this._popup.setContent("<b>"+i+"</b>"),this._popup.openOn(this._map))}else this._map.closePopup(this._popup)}}}),L.gridLayer.geoJson=function(e,t){return new L.GridLayer.GeoJSON(e,t)};var g={GeoJSON:L.GridLayer.GeoJSON},m={geoJSON:L.gridLayer.geoJson};e.GridLayer=g,e.KMZLoader=f,e.KMZMarker=y,e.KMZParser=c,e.gridLayer=m,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=leaflet-kmz.js.map
