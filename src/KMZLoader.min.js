goog.provide("module$C_$MAMP$htdocs$wp_test$wp_content$uploads$kml$leaflet_kmz$src$KMZLoader");
L.KMZLoader=L.Class.extend({options:{renderer:true,tiled:true,interactive:true,ballon:true,bindPopup:true,bindTooltip:true,debug:0,keepFront:true,emptyIcon:"data:image/png;"+"base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAFElEQVR4XgXAAQ0AAABAMP1L30IDCPwC/o5WcS4AAAAASUVORK5CYII="},initialize:function(opts){L.setOptions(this,opts);this.renderer=this.options.renderer;this.tiled=this.options.tiled;this.interactive=this.options.interactive;this.pointable=this.tiled&&!this.interactive&&this.options.pointable;
this.emptyIcon=this.options.emptyIcon;this.name=this.options.name;this.callback=opts.onKMZLoaded},parse:function(kmzUrl){this.name=this.name?this.name:kmzUrl.split("/").pop();this._load(kmzUrl)},_load:function(url){this._getBinaryContent(url,function(err,data){if(err!=null)console.error(url,err,data);else this._parse(data)}.bind(this))},_parse:function(data){return this._isZipped(data)?this._parseKMZ(data):this._parseKML(data)},_parseKMZ:function(data){var $jscomp$this=this;var that=this;JSZip.loadAsync(data).then(function(zip){Promise.all(that._mapZipFiles(zip)).then(function(list){Promise.all(that._mapListFiles(list)).then(function(data){var kmlString=
$jscomp$this._decodeKMZFolder(data);that._parseKML(kmlString)})})})},_parseKML:function(data){var kmlString=this._decodeKMLString(data);var xmlDoc=this._toXML(kmlString);this._kmlToLayer(xmlDoc)},_decodeKMLString:function(data){return data instanceof ArrayBuffer?String.fromCharCode.apply(null,new Uint8Array(data)):data},_decodeKMZFolder:function(data){var kmzFiles=this._listToObject(data);var kmlDoc=this._getKmlDoc(kmzFiles);var images=this._getImageFiles(Object.keys(kmzFiles));var kmlString=kmzFiles[kmlDoc];
for(var i in images){var imageUrl=images[i];var dataUrl=kmzFiles[imageUrl];kmlString=this._replaceAll(kmlString,imageUrl,dataUrl)}return kmlString},_toXML:function(text){return(new DOMParser).parseFromString(text,"text/xml")},_toGeoJSON:function(xmlDoc){return(toGeoJSON||window.toGeoJSON).kml(xmlDoc)},_keepFront:function(layer){var keepFront=function(e){if(this.bringToFront)this.bringToFront()}.bind(layer);layer.on("add",function(e){this._map.on("baselayerchange",keepFront)});layer.on("remove",function(e){this._map.off("baselayerchange",
keepFront)})},_kmlToLayer:function(xmlDoc){var data=this._toGeoJSON(xmlDoc);if(this.interactive){this.geojson=L.geoJson(data,{pointToLayer:this._pointToLayer.bind(this),onEachFeature:this._onEachFeature.bind(this),kmzRenderer:this.renderer});this.layer=this.geojson}if(this.tiled){this.gridlayer=L.gridLayer.geoJson(data,{pointable:this.pointable,ballon:this.options.ballon,bindPopup:this.options.bindPopup,bindTooltip:this.options.bindTooltip});this.layer=this.interactive?L.featureGroup([this.gridlayer,
this.geojson]):this.gridlayer}if(this.layer)this._onKMZLoaded(this.layer,this.name)},_pointToLayer:function(feature,latlng){return new L.KMZMarker(latlng,{kmzRenderer:this.renderer})},_onEachFeature:function(feature,layer){switch(feature.geometry.type){case "Point":this._setLayerPointIcon(feature,layer);break;case "LineString":case "Polygon":case "GeometryCollection":this._setLayerStyle(feature,layer);break;default:console.warn("Unsupported feature type: "+feature.geometry.type,feature);break}this._setLayerBalloon(feature,
layer)},_onKMZLoaded:function(layer,name){if(this.options.debug)console.log(layer,name);if(this.options.keepFront)this._keepFront(layer);if(this.callback)this.callback(layer,name)},_setLayerPointIcon:function(feature,layer){layer.setIconUrl(this.tiled?this.emptyIcon:feature.properties.icon)},_setLayerStyle:function(feature,layer){var styles={weight:1,opacity:0,fillOpacity:0};if(!this.tiled){if(feature.properties["stroke-width"])styles.weight=feature.properties["stroke-width"]*1.05;if(feature.properties["stroke-opacity"])styles.opacity=
feature.properties["stroke-opacity"];if(feature.properties["fill-opacity"])styles.fillOpacity=feature.properties["fill-opacity"];if(feature.properties.stroke)styles.color=feature.properties.stroke;if(feature.properties.fill)styles.fillColor=feature.properties.fill}layer.setStyle(styles)},_setLayerBalloon:function(feature,layer){if(!this.options.ballon)return;var name=feature.properties.name?feature.properties.name:"";var desc=feature.properties.description?feature.properties.description:"";if(name||
desc){if(this.options.bindPopup)layer.bindPopup("<div>"+"<b>"+name+"</b>"+"<br>"+desc+"</div>");if(this.options.bindTooltip)layer.bindTooltip("<b>"+name+"</b>",{direction:"auto",sticky:true})}},_escapeRegExp:function(str){return str.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},_replaceAll:function(str,find,replace){return str.replace(new RegExp(this._escapeRegExp(find),"g"),replace)},_mapZipFiles:function(zip){return Object.keys(zip.files).map(function(name){return zip.files[name]}).map(function(entry){return entry.async("blob").then(function(value){return[entry.name,
value]})})},_mapListFiles:function(list){var $jscomp$this=this;return list.map(function(file){return Promise.resolve().then(function(){return $jscomp$this._readFile(file)})})},_listToObject:function(list){return list.reduce(function(newObj,listElem){newObj[listElem[0]]=listElem[1];return newObj},{})},_getFileExt:function(filename){return filename.split(".").pop().toLowerCase().replace("jpg","jpeg")},_getMimeType:function(filename,ext){var mime="text/plain";if(/\.(jpe?g|png|gif|bmp)$/i.test(filename))mime=
"image/"+ext;else if(/\.kml$/i.test(filename))mime="text/plain";return mime},_getKmlDoc:function(files){return files["doc.kml"]?"doc.kml":this._getKmlFiles(Object.keys(files))[0]},_getKmlFiles:function(files){return files.filter(function(file){return/.*\.kml/.test(file)})},_getImageFiles:function(files){return files.filter(function(file){return/\.(jpe?g|png|gif|bmp)$/i.test(file)})},_isZipped:function(file){var P=new Uint8Array(file,0,1);var K=new Uint8Array(file,1,1);var PK=String.fromCharCode(P,
K);return"PK"===PK},_readFile:function(file){var filename=file[0];var fileblob=file[1];var ext=this._getFileExt(filename);var mime=this._getMimeType(filename,ext);return this._fileReader(fileblob,mime,filename)},_fileReader:function(blob,mime,name){return new Promise(function(resolve,reject){var fr=new FileReader;fr.onload=function(){var result=fr.result;if(mime.indexOf("text")===-1){var dataUrl=fr.result;var base64=dataUrl.split(",")[1];result="data:"+mime+";base64,"+base64}return resolve([name,
result])};if(mime.indexOf("text")===-1)fr.readAsDataURL(blob);else fr.readAsText(blob)})},_getBinaryContent:function(path,callback){try{var xhr=new window.XMLHttpRequest;xhr.open("GET",path,true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.responseType="arraybuffer";xhr.onreadystatechange=function(evt){var file,err;if(xhr.readyState===4)if(xhr.status===200||xhr.status===0){file=null;err=null;try{file=xhr.response||xhr.responseText}catch(e){err=new Error(e)}callback(err,file)}else callback(new Error("Ajax error for "+
path+" : "+this.status+" "+this.statusText),null)};xhr.send()}catch(e){callback(new Error(e),null)}},_blobToString:function(b){var u,x;u=URL.createObjectURL(b);x=new XMLHttpRequest;x.open("GET",u,false);x.send();URL.revokeObjectURL(u);return x.responseText},_blobToBase64:function(blob,callback){var reader=new FileReader;reader.onload=function(){var dataUrl=reader.result;var base64=dataUrl.split(",")[1];callback(base64)};reader.readAsDataURL(blob)}});
var mapProto$$module$C_$MAMP$htdocs$wp_test$wp_content$uploads$kml$leaflet_kmz$src$KMZLoader=L.Map.prototype;var getRendererMapProto$$module$C_$MAMP$htdocs$wp_test$wp_content$uploads$kml$leaflet_kmz$src$KMZLoader=mapProto$$module$C_$MAMP$htdocs$wp_test$wp_content$uploads$kml$leaflet_kmz$src$KMZLoader.getRenderer;L.Map.addInitHook(function(){this.options.kmzRenderer=L.canvas({padding:.5})});
L.Map.include({getRenderer:function(layer){if(layer&&layer.options&&layer.options.kmzRenderer)if(layer.options.kmzRenderer instanceof L.Renderer)layer.options.renderer=layer.options.kmzRenderer;else if(layer.options.kmzRenderer)layer.options.renderer=this.options.kmzRenderer;var renderer=getRendererMapProto$$module$C_$MAMP$htdocs$wp_test$wp_content$uploads$kml$leaflet_kmz$src$KMZLoader.call(this,layer);return renderer}});
var KMZLoader$$module$C_$MAMP$htdocs$wp_test$wp_content$uploads$kml$leaflet_kmz$src$KMZLoader=L.KMZLoader;module$C_$MAMP$htdocs$wp_test$wp_content$uploads$kml$leaflet_kmz$src$KMZLoader.KMZLoader=KMZLoader$$module$C_$MAMP$htdocs$wp_test$wp_content$uploads$kml$leaflet_kmz$src$KMZLoader;
